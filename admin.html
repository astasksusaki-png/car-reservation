<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>社用車予約 管理</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", sans-serif; margin:16px; line-height:1.5;}
    .card{border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0;}
    label{display:block; margin-top:10px; font-weight:600;}
    input, select, button{padding:10px; font-size:16px; margin-top:6px;}
    button{cursor:pointer;}
    table{width:100%; border-collapse:collapse; margin-top:12px;}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .small{color:#666; font-size:13px;}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>社用車予約 管理</h1>
  <div class="card">
    <div id="status" class="small">初期化中…</div>

    <div class="row">
      <div>
        <label>車</label>
        <select id="car"></select>
      </div>
      <div>
        <label>開始（この日時以降）</label>
        <input id="from" type="datetime-local" />
      </div>
      <div>
        <label>終了（この日時以前）</label>
        <input id="to" type="datetime-local" />
      </div>
      <div>
        <button id="loadBtn">検索</button>
      </div>
      <div>
        <button id="csvBtn">CSV出力</button>
      </div>
    </div>

    <div id="result" class="small"></div>
    <div id="tableWrap"></div>
  </div>

<script>
  // ★ここをあなたの値に差し替え
 const LIFF_ID = "2008829976-rJa7ANlR";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  // ★管理者のLINE userIdをここに列挙（あなたのuserIdを入れる）
  const ADMIN_USER_IDS = [
    "ADMIN_USER_ID_1"
  ];

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id) => document.getElementById(id);

  let rowsCache = [];

  function toISO(dtLocal){
    if(!dtLocal) return null;
    return new Date(dtLocal).toISOString();
  }

  function download(filename, text){
    const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      $("status").textContent = "未ログイン：ログインします…";
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    const me = { userId: profile.userId, displayName: profile.displayName };

    if(!ADMIN_USER_IDS.includes(me.userId)){
      $("status").innerHTML = `アクセス拒否（管理者のみ）`;
      $("tableWrap").innerHTML = "";
      return;
    }

    $("status").innerHTML = `管理者：${me.displayName}`;
    await loadCars();
  }

  async function loadCars(){
    const { data, error } = await sb.from("cars").select("*").order("id");
    if(error) throw error;
    $("car").innerHTML = `<option value="">（全車）</option>` + data.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
  }

  async function search(){
    const carId = $("car").value ? Number($("car").value) : null;
    const fromISO = toISO($("from").value);
    const toISOv = toISO($("to").value);

    let q = sb
      .from("reservations")
      .select("car_id, user_name, user_id, start_time, end_time, note, created_at, cars(name)")
      .order("start_time", { ascending: true })
      .limit(500);

    if(carId) q = q.eq("car_id", carId);
    if(fromISO) q = q.gte("start_time", fromISO);
    if(toISOv) q = q.lte("end_time", toISOv);

    const { data, error } = await q;
    if(error){
      console.error(error);
      $("result").textContent = "検索エラー：設定値/テーブルを確認";
      return;
    }

    rowsCache = data;
    $("result").textContent = `${data.length} 件`;

    renderTable(data);
  }

  function renderTable(data){
    if(data.length === 0){
      $("tableWrap").innerHTML = "<p class='small'>データなし</p>";
      return;
    }

    const html = `
      <table>
        <thead>
          <tr>
            <th>車</th>
            <th>開始</th>
            <th>終了</th>
            <th>利用者</th>
            <th>用途</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(r=>{
            const car = r.cars?.name ?? ("車ID:" + r.car_id);
            const s = new Date(r.start_time).toLocaleString();
            const e = new Date(r.end_time).toLocaleString();
            const note = r.note ?? "";
            return `<tr>
              <td>${car}</td>
              <td>${s}</td>
              <td>${e}</td>
              <td>${r.user_name}</td>
              <td>${note}</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
    $("tableWrap").innerHTML = html;
  }

  function exportCSV(){
    if(rowsCache.length === 0){
      alert("先に検索してください");
      return;
    }
    const header = ["car","start_time","end_time","user_name","user_id","note"].join(",");
    const lines = rowsCache.map(r=>{
      const car = (r.cars?.name ?? ("car_id:" + r.car_id)).replaceAll('"','""');
      const note = (r.note ?? "").replaceAll('"','""');
      return [
        `"${car}"`,
        `"${r.start_time}"`,
        `"${r.end_time}"`,
        `"${(r.user_name ?? "").replaceAll('"','""')}"`,
        `"${(r.user_id ?? "").replaceAll('"','""')}"`,
        `"${note}"`
      ].join(",");
    });
    download("reservations.csv", [header, ...lines].join("\n"));
  }

  $("loadBtn").addEventListener("click", search);
  $("csvBtn").addEventListener("click", exportCSV);

  init().catch(e=>{
    console.error(e);
    $("status").textContent = "初期化エラー：LIFF_ID / SUPABASE 設定を確認";
  });
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>社用車予約（管理画面）</title>

  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:12px;line-height:1.5;}
    h2{margin:0 0 8px 0;}
    h3{margin:16px 0 8px 0; font-size:16px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:12px; color:#444;}
    #status{font-size:13px;color:#666;margin-bottom:10px;}
    input, select, button{padding:10px; font-size:16px;}
    button{cursor:pointer;}
    .card{border:1px solid #eee; border-radius:12px; padding:12px; background:#fff;}
    .small{font-size:12px;color:#666;}
    table{width:100%; border-collapse:collapse; margin-top:8px;}
    th, td{border-bottom:1px solid #eee; padding:8px; font-size:14px; text-align:left; vertical-align:top;}
    th{background:#fafafa; position:sticky; top:0;}
    .muted{color:#666;}
    .danger{color:#b00020; font-weight:700;}
    .userLink{ color:#0b57d0; text-decoration:underline; cursor:pointer; }

    /* 時間セルをクリックできる見た目 */
    .timeLink{
      color:#0b57d0;
      text-decoration:underline;
      cursor:pointer;
      white-space:nowrap;
    }

    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .modal{
      width:100%;
      max-width:420px;
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
      box-sizing:border-box;
    }
    .modal h3{margin:0 0 8px 0; font-size:18px;}
    .modal label{display:block; font-size:13px; color:#444; margin-top:10px;}
    .modal input, .modal select, .modal textarea{
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      padding:10px;
      font-size:16px;
      margin-top:6px;
    }
    .modal textarea{ resize:vertical; }
    .modal .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px;}

    .tagStop{
      display:inline-block; padding:2px 8px; border-radius:999px;
      background:#ffe8e8; color:#b00020; font-size:12px; font-weight:700;
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <h2><b>社用車予約（管理画面）</b></h2>
  <div id="status">初期化中…</div>

  <div class="row">
    <span class="small">ログイン：</span>
    <span id="meName" class="pill">未ログイン</span>
    <span id="meUid" class="pill" style="display:none;"></span>
  </div>

  <!-- ✅ 予約一覧（上）＋ 期間指定CSV ＋ 利用者検索 -->
  <div class="card" style="margin-top:12px;">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0;">予約一覧（今後の予約が基本）</h3>
      <div class="row">
        <button id="reloadBtn">再読み込み</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <span class="small">車：</span>
      <select id="carFilter">
        <option value="all">全車</option>
      </select>

      <span class="small">表示：</span>
      <select id="modeFilter">
        <option value="future" selected>今後のみ（今日以降）</option>
        <option value="range">期間指定</option>
      </select>

      <span class="small">利用者：</span>
      <input id="userSearch" type="text" placeholder="例：山田 / 太郎 / 田" style="min-width:180px;">
      <button id="clearUserSearchBtn" type="button">クリア</button>
    </div>

    <div id="rangeBox" class="row" style="margin-top:8px; display:none;">
      <span class="small">開始日：</span>
      <input id="rangeStart" type="date">
      <span class="small">終了日：</span>
      <input id="rangeEnd" type="date">
      <button id="applyRangeBtn">この期間で表示</button>
      <button id="downloadCsvBtn">CSVダウンロード</button>
      <span class="small muted">※取り消し（削除）済み予約は含まれません</span>
    </div>

    <div class="small muted" style="margin-top:8px;">
      ※ 時間（青い下線）を押すと、その予約の「時間/車/用途」を変更できます（管理者）<br>
      ※ 利用者名を押すと、その人の表示名を変更できます（予約表示にも反映）
    </div>

    <div id="reservationsBox" style="margin-top:10px;">読み込み中…</div>
  </div>

  <!-- ✅ 管理者の追加／削除 -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin-top:0;">管理者の追加／削除</h3>
    <div class="small muted">※ user_id を指定して admins テーブルを編集します</div>

    <div class="row" style="margin-top:10px;">
      <input id="newAdminUserId" type="text" placeholder="追加する user_id（例：Uxxxxxxxx）" style="min-width:260px; flex:1;">
      <button id="addAdminBtn">管理者に追加</button>
    </div>

    <div id="adminsBox" style="margin-top:10px;">読み込み中…</div>
  </div>

  <!-- ✅ 車名編集＋使用停止（点検中） -->
  <div class="card" style="margin-top:12px;">
    <h3 style="margin-top:0;">車名の編集／使用停止（点検中）</h3>
    <div class="small muted">※ 使用停止にすると予約画面で「点検中」と表示され、予約不可になります</div>
    <div id="carsBox" style="margin-top:10px;">読み込み中…</div>
  </div>

  <!-- ✅ 名前編集モーダル -->
  <div id="nameOverlay" class="overlay">
    <div class="modal">
      <h3>利用者名の変更</h3>
      <div class="small" id="targetUserId" style="word-break:break-all;"></div>

      <label>苗字</label>
      <input id="editLastName" type="text" placeholder="例：山田">

      <label>名前</label>
      <input id="editFirstName" type="text" placeholder="例：太郎">

      <div class="actions">
        <button id="cancelNameBtn">キャンセル</button>
        <button id="saveNameBtn">保存</button>
      </div>
    </div>
  </div>

  <!-- ✅ 予約時間変更モーダル（管理者） -->
  <div id="resvOverlay" class="overlay">
    <div class="modal">
      <h3>予約の時間変更（管理者）</h3>
      <div id="resvInfo" class="small"></div>

      <label>車</label>
      <select id="resvCar"></select>

      <div class="row2">
        <div>
          <label>開始（15分刻み）</label>
          <select id="resvStart"></select>
        </div>
        <div>
          <label>終了（15分刻み）</label>
          <select id="resvEnd"></select>
        </div>
      </div>

      <label>用途メモ</label>
      <textarea id="resvNote" rows="2" placeholder="例：顧客訪問、備品搬入など"></textarea>

      <div class="actions">
        <button id="resvCancelBtn">閉じる</button>
        <button id="resvSaveBtn">変更する</button>
      </div>
    </div>
  </div>

<script>
  // ✅ あなたの値
  const LIFF_ID = "2008829976-rJa7ANlR";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id)=>document.getElementById(id);

  const me = { userId:null, displayName:null };
  let carsMap = {};         // id -> name
  let carsActiveMap = {};   // id -> is_active(true/false)
  let editingUserId = null;

  // 予約編集
  let editingResvId = null;
  let editingResvYmd = null; // 開始日基準の日付（YYYY-MM-DD）
  const pad = (n)=>String(n).padStart(2,"0");
  const fmtYmd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const fmtHm = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const TIMES = [...Array(96)].map((_,i)=>`${pad(Math.floor(i/4))}:${pad((i%4)*15)}`);

  function todayStartLocal(){
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
  }
  function ymdToLocalStartISO(ymd){
    const [y,m,d] = ymd.split("-").map(Number);
    return new Date(y, m-1, d, 0, 0, 0, 0).toISOString();
  }
  function ymdToLocalEndExclusiveISO(ymd){
    const [y,m,d] = ymd.split("-").map(Number);
    return new Date(y, m-1, d+1, 0, 0, 0, 0).toISOString();
  }
  function toISOFromYmdTime(ymd, hhmm){
    const [y, m, d] = ymd.split("-").map(Number);
    if (hhmm === "24:00") return new Date(y, m-1, d+1, 0,0,0,0).toISOString();
    const [hh, mm] = hhmm.split(":").map(Number);
    return new Date(y, m-1, d, hh, mm, 0, 0).toISOString();
  }

  function showNameModal(uid, last="", first=""){
    editingUserId = uid;
    $("targetUserId").textContent = `user_id：${uid}`;
    $("editLastName").value = last || "";
    $("editFirstName").value = first || "";
    $("nameOverlay").style.display = "flex";
  }
  function hideNameModal(){
    $("nameOverlay").style.display = "none";
    editingUserId = null;
  }

  function showResvModal(r){
    // r: { id, car_id, user_name, start_time, end_time, note }
    editingResvId = r.id;
    const s = new Date(r.start_time);
    const e = new Date(r.end_time);
    editingResvYmd = fmtYmd(s);

    // 車セレクト
    $("resvCar").innerHTML = Object.keys(carsMap).sort((a,b)=>Number(a)-Number(b)).map(id=>{
      const name = carsMap[id];
      const stop = (carsActiveMap[id] === false) ? "（点検中）" : "";
      return `<option value="${id}" data-active="${carsActiveMap[id] === false ? "0":"1"}">${name}${stop}</option>`;
    }).join("");
    $("resvCar").value = String(r.car_id);

    // 時刻セレクト
    $("resvStart").innerHTML = TIMES.map(t=>`<option value="${t}">${t}</option>`).join("");
    $("resvEnd").innerHTML = [...TIMES,"24:00"].map(t=>`<option value="${t}">${t}</option>`).join("");

    $("resvStart").value = fmtHm(s);
    $("resvEnd").value = fmtHm(e);
    $("resvNote").value = r.note || "";

    $("resvInfo").textContent = `利用者：${r.user_name || ""} / 日付：${editingResvYmd}`;
    $("resvOverlay").style.display = "flex";
  }

  function hideResvModal(){
    $("resvOverlay").style.display = "none";
    editingResvId = null;
    editingResvYmd = null;
  }

  async function initLiff(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return false; }
    const p = await liff.getProfile();
    me.userId = p.userId;
    me.displayName = p.displayName;
    $("meName").textContent = me.displayName;
    $("meUid").textContent = me.userId;
    return true;
  }

  async function requireAdmin(){
    const { data, error } = await sb
      .from("admins")
      .select("user_id")
      .eq("user_id", me.userId)
      .maybeSingle();

    if(error){
      console.error(error);
      $("status").textContent = "管理者チェック失敗";
      alert("管理者チェックに失敗しました。");
      throw error;
    }
    if(!data){
      document.body.innerHTML = `
        <h2 class="danger">アクセス拒否（管理者のみ）</h2>
        <div class="small">このアカウントは管理者ではありません。</div>
      `;
      throw new Error("not admin");
    }
  }

  // ===== 管理者一覧 =====
  async function loadAdmins(){
    const { data, error } = await sb.from("admins").select("user_id").order("user_id");
    if(error){
      console.error(error);
      $("adminsBox").innerHTML = `<div class="small">admins の取得に失敗しました</div>`;
      return;
    }

    const rows = data || [];
    if(rows.length === 0){
      $("adminsBox").innerHTML = `<div class="small">管理者がいません</div>`;
      return;
    }

    $("adminsBox").innerHTML = `
      <table>
        <thead><tr><th>user_id</th><th>操作</th></tr></thead>
        <tbody>
          ${rows.map(r=>{
            const isMe = r.user_id === me.userId;
            return `
              <tr>
                <td style="word-break:break-all;">
                  ${r.user_id} ${isMe ? '<span class="pill">自分</span>' : ''}
                </td>
                <td>
                  <button data-del-admin="${r.user_id}" ${isMe ? "disabled" : ""}>
                    削除
                  </button>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
      <div class="small muted" style="margin-top:6px;">※自分自身は削除できないようにしています</div>
    `;

    document.querySelectorAll("button[data-del-admin]").forEach(btn=>{
      btn.onclick = async ()=>{
        const uid = btn.dataset.delAdmin;
        if(!confirm(`この管理者を削除しますか？\n${uid}`)) return;

        btn.disabled = true;
        try{
          const { error } = await sb.from("admins").delete().eq("user_id", uid);
          if(error) throw error;
          await loadAdmins();
          alert("削除しました");
        }catch(e){
          console.error(e);
          alert("削除に失敗しました（権限/RLSを確認）");
        }finally{
          btn.disabled = false;
        }
      };
    });
  }

  async function addAdmin(){
    const uid = ($("newAdminUserId").value || "").trim();
    if(!uid){
      alert("user_id を入力してください");
      return;
    }
    $("addAdminBtn").disabled = true;
    try{
      const { error } = await sb.from("admins").insert({ user_id: uid });
      if(error) throw error;
      $("newAdminUserId").value = "";
      await loadAdmins();
      alert("追加しました");
    }catch(e){
      console.error(e);
      alert("追加に失敗しました（重複/権限/RLSを確認）");
    }finally{
      $("addAdminBtn").disabled = false;
    }
  }

  // ===== 車 =====
  async function loadCars(){
    const { data, error } = await sb.from("cars").select("*").order("id");
    if(error) throw error;

    carsMap = {};
    carsActiveMap = {};
    (data||[]).forEach(c=>{
      carsMap[c.id]=c.name;
      carsActiveMap[c.id] = (c.is_active !== false);
    });

    // フィルタ
    const current = $("carFilter").value;
    $("carFilter").innerHTML =
      `<option value="all">全車</option>` +
      (data||[]).map(c=>{
        const stop = (c.is_active === false) ? "（点検中）" : "";
        return `<option value="${c.id}">${c.name}${stop}</option>`;
      }).join("");
    if(current) $("carFilter").value = current;

    // 車編集 + 使用停止
    $("carsBox").innerHTML = (data||[]).map(c=>{
      const isStop = (c.is_active === false);
      return `
        <div class="row" style="align-items:center;">
          <span class="pill">ID:${c.id}</span>
          ${isStop ? `<span class="tagStop">点検中</span>` : ``}

          <input id="carName_${c.id}" value="${String(c.name||"").replaceAll('"','&quot;')}"
                 style="flex:1; min-width:180px;">

          <label class="small" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="carStop_${c.id}" ${isStop ? "checked" : ""}>
            使用停止（点検中）
          </label>

          <button data-save-car="${c.id}">保存</button>
        </div>
      `;
    }).join("");

    document.querySelectorAll("button[data-save-car]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = Number(btn.dataset.saveCar);
        const name = ($("carName_"+id).value || "").trim();
        const stop = $("carStop_"+id).checked; // trueなら点検中

        if(!name){
          alert("車名を入力してください");
          return;
        }

        btn.disabled = true;
        try{
          const { error } = await sb.from("cars")
            .update({ name, is_active: !stop })
            .eq("id", id);
          if(error) throw error;

          await loadCars();
          await loadReservations();
          alert("保存しました");
        }catch(e){
          console.error(e);
          alert("保存に失敗しました（cars.is_active カラムを確認）");
        }finally{
          btn.disabled = false;
        }
      };
    });
  }

  // ===== 予約一覧 =====
  function getFilterParams(){
    const car = $("carFilter").value;
    const mode = $("modeFilter").value;
    const userQuery = ($("userSearch").value || "").trim();

    if(mode === "future"){
      return { car, mode, userQuery, startISO: todayStartLocal().toISOString(), endISO: null };
    }

    const s = $("rangeStart").value;
    const e = $("rangeEnd").value;
    if(!s || !e) return { car, mode, userQuery, invalid:true };

    return { car, mode, userQuery, startISO: ymdToLocalStartISO(s), endISO: ymdToLocalEndExclusiveISO(e), invalid:false };
  }

  async function fetchReservationsForTable(){
    const p = getFilterParams();

    let q = sb.from("reservations")
      .select("id, car_id, user_id, user_name, start_time, end_time, note")
      .order("start_time", { ascending: false });

    if(p.car !== "all") q = q.eq("car_id", Number(p.car));
    if(p.mode === "future") q = q.gte("start_time", p.startISO);
    if(p.mode === "range"){
      if(p.invalid) return { data:[], error:null, invalid:true };
      q = q.gte("start_time", p.startISO).lt("start_time", p.endISO);
    }

    const { data, error } = await q;
    if(error) return { data:[], error, invalid:false };

    let rows = data || [];
    if(p.userQuery){
      const key = p.userQuery.toLowerCase();
      rows = rows.filter(r => String(r.user_name||"").toLowerCase().includes(key));
    }
    return { data: rows, error:null, invalid:false };
  }

  async function loadReservations(){
    const { data, error, invalid } = await fetchReservationsForTable();
    if(invalid){
      $("reservationsBox").innerHTML = `<div class="small">開始日と終了日を入力してください。</div>`;
      return;
    }
    if(error){
      console.error(error);
      $("reservationsBox").innerHTML = `<div class="small">取得に失敗しました。</div>`;
      return;
    }
    if(!data.length){
      $("reservationsBox").innerHTML = `<div class="small">予約はありません</div>`;
      return;
    }

    $("reservationsBox").innerHTML = `
      <table>
        <thead>
          <tr><th>車</th><th>日付</th><th>時間（クリックで変更）</th><th>利用者（クリックで編集）</th><th>用途</th></tr>
        </thead>
        <tbody>
          ${data.map(r=>{
            const s=new Date(r.start_time), e=new Date(r.end_time);
            const carName = carsMap?.[Number(r.car_id)] ?? `車ID:${r.car_id}`;
            const uname = r.user_name || "(未設定)";
            const uid = r.user_id || "";
            const ymd = fmtYmd(s);
            const t = `${fmtHm(s)}〜${fmtHm(e)}`;
            const note = r.note || "";
            return `
              <tr>
                <td>${carName}</td>
                <td>${ymd}</td>
                <td><span class="timeLink" data-resv='${JSON.stringify({
                  id: r.id,
                  car_id: r.car_id,
                  user_name: r.user_name || "",
                  start_time: r.start_time,
                  end_time: r.end_time,
                  note: note
                }).replaceAll("'","&#39;")}'>${t}</span></td>
                <td><span class="userLink" data-uid="${uid}">${uname}</span></td>
                <td>${note}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    // 利用者名クリック：名前編集
    document.querySelectorAll(".userLink").forEach(el=>{
      el.addEventListener("click", async ()=>{
        const uid = el.getAttribute("data-uid");
        if(!uid){
          alert("この予約には user_id がありません（古いデータの可能性）");
          return;
        }
        const { data, error } = await sb
          .from("users")
          .select("last_name, first_name")
          .eq("user_id", uid)
          .maybeSingle();

        if(error){
          console.error(error);
          showNameModal(uid, "", "");
          return;
        }
        showNameModal(uid, data?.last_name||"", data?.first_name||"");
      });
    });

    // 時間クリック：予約時間変更
    document.querySelectorAll(".timeLink").forEach(el=>{
      el.addEventListener("click", ()=>{
        const raw = el.getAttribute("data-resv");
        if(!raw) return;
        try{
          const r = JSON.parse(raw);
          showResvModal(r);
        }catch(e){
          console.error(e);
          alert("予約データの解析に失敗しました");
        }
      });
    });
  }

  // ===== 予約時間変更 保存（管理者）=====
  async function saveReservationEdit(){
    if(!editingResvId || !editingResvYmd){
      alert("編集中の予約がありません");
      return;
    }

    const carSel = $("resvCar");
    const carId = Number(carSel.value);

    // 点検中は予約不可（管理者でも不可）
    const isActive = (carSel.selectedOptions[0]?.dataset.active === "1");
    if(!isActive){
      alert("点検中の車は予約できません（別の車にしてください）");
      return;
    }

    const startStr = $("resvStart").value;
    const endStr = $("resvEnd").value;

    const startISO = toISOFromYmdTime(editingResvYmd, startStr);
    const endISO = toISOFromYmdTime(editingResvYmd, endStr);

    if(new Date(startISO) >= new Date(endISO)){
      alert("終了は開始より後にしてください。");
      return;
    }

    // 重複チェック（自分自身は除外）
    const { data: ov, error: ovErr } = await sb
      .from("reservations")
      .select("id")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .neq("id", editingResvId)
      .limit(1);

    if(ovErr){
      console.error(ovErr);
      alert("重複チェックに失敗しました");
      return;
    }
    if((ov||[]).length > 0){
      alert("その時間帯はすでに予約があります。");
      return;
    }

    const note = ($("resvNote").value || "").trim();

    $("resvSaveBtn").disabled = true;
    try{
      const { error } = await sb
        .from("reservations")
        .update({ car_id: carId, start_time: startISO, end_time: endISO, note })
        .eq("id", editingResvId);

      if(error) throw error;

      alert("変更しました");
      hideResvModal();
      await loadReservations();
    }catch(e){
      console.error(e);
      alert("変更に失敗しました（権限/RLS/カラムを確認）");
    }finally{
      $("resvSaveBtn").disabled = false;
    }
  }

  // ===== CSV（期間指定のみ + 利用者検索も反映）=====
  function csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }
  function downloadTextFile(filename, text){
    const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  async function downloadCsv(){
    if($("modeFilter").value !== "range"){
      alert("CSVダウンロードは「期間指定」に切り替えてください。");
      return;
    }
    const p = getFilterParams();
    if(p.invalid){
      alert("開始日と終了日を入力してください。");
      return;
    }

    let q = sb.from("reservations")
      .select("car_id, user_name, start_time, end_time, note")
      .gte("start_time", p.startISO).lt("start_time", p.endISO)
      .order("start_time", { ascending: true });

    if(p.car !== "all") q = q.eq("car_id", Number(p.car));

    const { data, error } = await q;
    if(error){
      console.error(error);
      alert("CSVの取得に失敗しました。");
      return;
    }

    let rows = data || [];
    if(p.userQuery){
      const key = p.userQuery.toLowerCase();
      rows = rows.filter(r => String(r.user_name||"").toLowerCase().includes(key));
    }

    const header = ["車","日付","開始","終了","利用者","用途メモ"];
    const lines = [header.map(csvEscape).join(",")];

    rows.forEach(r=>{
      const s = new Date(r.start_time);
      const e = new Date(r.end_time);
      const carName = carsMap?.[Number(r.car_id)] ?? `車ID:${r.car_id}`;
      lines.push([carName, fmtYmd(s), fmtHm(s), fmtHm(e), r.user_name||"", r.note||""].map(csvEscape).join(","));
    });

    const csv = "\uFEFF" + lines.join("\n");
    const sYmd = $("rangeStart").value;
    const eYmd = $("rangeEnd").value;
    const carPart = (p.car === "all") ? "全車" : (carsMap?.[Number(p.car)] ?? `車${p.car}`);
    const namePart = p.userQuery ? `_${p.userQuery}` : "";
    downloadTextFile(`社用車予約_${carPart}${namePart}_${sYmd}〜${eYmd}.csv`, csv);
  }

  // ===== 名前保存（users + reservations.user_name を一括更新）=====
  $("cancelNameBtn").addEventListener("click", hideNameModal);
  $("saveNameBtn").addEventListener("click", async ()=>{
    if(!editingUserId) return;

    const last = ($("editLastName").value || "").trim();
    const first = ($("editFirstName").value || "").trim();
    if(!last || !first){ alert("苗字・名前を入力してください。"); return; }

    const newFull = `${last} ${first}`;
    $("saveNameBtn").disabled = true;
    try{
      const { error: e1 } = await sb.from("users").upsert({ user_id: editingUserId, last_name: last, first_name: first });
      if(e1) throw e1;

      const { error: e2 } = await sb.from("reservations").update({ user_name: newFull }).eq("user_id", editingUserId);
      if(e2) throw e2;

      alert("保存しました。予約表示名も更新されます。");
      hideNameModal();
      await loadReservations();
    }catch(e){
      console.error(e);
      alert("保存に失敗しました（権限/RLS/カラム名を確認）");
    }finally{
      $("saveNameBtn").disabled = false;
    }
  });

  // ===== 予約編集モーダル ボタン =====
  $("resvCancelBtn").addEventListener("click", hideResvModal);
  $("resvSaveBtn").addEventListener("click", saveReservationEdit);

  // ===== UI =====
  function syncRangeBox(){
    $("rangeBox").style.display = ($("modeFilter").value === "range") ? "flex" : "none";
  }

  $("reloadBtn").onclick = async ()=>{
    await loadCars();
    await loadAdmins();
    await loadReservations();
  };

  $("carFilter").onchange = loadReservations;
  $("modeFilter").onchange = async ()=>{ syncRangeBox(); await loadReservations(); };
  $("applyRangeBtn").onclick = loadReservations;

  let searchTimer = null;
  $("userSearch").addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(loadReservations, 200);
  });
  $("clearUserSearchBtn").addEventListener("click", ()=>{
    $("userSearch").value = "";
    loadReservations();
  });

  $("downloadCsvBtn").onclick = downloadCsv;

  $("addAdminBtn").onclick = addAdmin;
  $("newAdminUserId").addEventListener("keydown",(e)=>{
    if(e.key==="Enter") addAdmin();
  });

  // 起動
  (async()=>{
    try{
      await initLiff();
      await requireAdmin();

      const t = todayStartLocal();
      const t2 = new Date(t.getFullYear(), t.getMonth(), t.getDate()+30, 0,0,0,0);
      $("rangeStart").value = fmtYmd(t);
      $("rangeEnd").value = fmtYmd(t2);
      syncRangeBox();

      await loadCars();
      await loadAdmins();
      await loadReservations();

      $("status").textContent = "表示中";
    }catch(e){
      console.error(e);
    }
  })();
</script>
</body>
</html>

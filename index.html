<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>アスタスク株式会社　社用車予約</title>

  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:12px;line-height:1.5;}
    .topbar{display:flex; flex-direction:column; align-items:flex-start; gap:6px; margin-bottom:10px;}
    .badge{font-size:13px;color:#444;}
    select, button, input{padding:10px;font-size:16px;}
    #status{font-size:13px;color:#666;}
    .hint{font-size:12px;color:#666;margin:6px 0 10px;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:12px; color:#444;}

    .fc .fc-toolbar-title{font-size:18px;}
    .fc .fc-col-header-cell-cushion{
      white-space: normal;
      font-size: 12px;
      line-height: 1.2;
      padding: 4px 2px;
    }

    /* 予約の見え方 */
    .fc .busy-other{ opacity: 0.35; }
    .fc .busy-other .fc-event-title,
    .fc .busy-other .fc-event-time{ display:none !important; }
    .fc .mine-event{ font-weight: 600; }

    /* ===== 点検中の車を選択している時：カレンダーを薄く ===== */
    .calendar-dim{
      opacity: 0.35;
      pointer-events: none; /* クリック無効 */
      filter: grayscale(0.2);
    }
    .dimBanner{
      display:none;
      margin:8px 0 0;
      padding:8px 10px;
      border-radius:10px;
      background:#fff3f3;
      border:1px solid #ffd2d2;
      color:#b00020;
      font-size:13px;
      font-weight:700;
    }

    /* モーダル共通 */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .modal{
      width:100%;
      max-width:420px;
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
      box-sizing:border-box;
    }
    .modal h3{margin:0 0 8px 0; font-size:18px;}
    .modal .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .modal label{display:block; font-size:13px; color:#444; margin-top:10px;}
    .modal textarea, .modal input, .modal select{
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      padding:10px;
      font-size:16px;
      margin-top:6px;
    }
    .modal textarea{resize:vertical;}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px;}
    .small{font-size:12px; color:#666;}

    /* 自分の予約一覧 */
    .myWrap{ margin-top:14px; }
    .myTitle{ font-size:18px; font-weight:800; margin:12px 0 8px; }
    .dateHeader{ font-size:14px; font-weight:700; margin:12px 0 6px; color:#333; }
    .myCard{
      border:1px solid #eee; border-radius:14px; padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:10px;
      background:#fff;
    }
    .myLeft{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .myMain{ font-size:16px; font-weight:700; color:#333; }
    .mySub{ font-size:12px; color:#666; word-break:break-word; }
    .myActions{ display:flex; gap:8px; flex-shrink:0; }
    .btnGhost{
      border:1px solid #ddd; background:#fff; border-radius:999px;
      padding:10px 14px; font-size:14px;
    }
    .btnDanger{
      border:0; background:#eee; border-radius:999px;
      padding:10px 14px; font-size:14px;
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
</head>

<body>
  <div class="topbar">
    <h2 style="margin:0;"><b>アスタスク株式会社　社用車予約</b></h2>
    <span id="status">初期化中…</span>

    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <span class="badge">車：</span>
      <select id="car"></select>
      <button id="reloadBtn">予約再読み込み</button>
    </div>

    <div id="dimBanner" class="dimBanner">選択中の車は「点検中」です（予約はできません）</div>
  </div>

  <div class="hint">
    ・時間枠をタップして開始→終了を15分刻みで選択<br>
    ・終日をタップすると 00:00〜24:00 を選択できます<br>
    ・予約表示名：<span id="displayName" class="pill">未設定</span>
  </div>

  <div id="calendar"></div>

  <!-- 自分の予約一覧 -->
  <div class="myWrap">
    <div class="myTitle">自分の予約一覧（全車／今日以降すべて）</div>
    <div id="myList">読み込み中…</div>
  </div>

  <!-- 予約作成モーダル -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h3>予約作成</h3>
      <div id="modalDate" class="small"></div>

      <div class="row">
        <div>
          <label>開始（15分刻み）</label>
          <select id="startSel"></select>
        </div>
        <div>
          <label>終了（15分刻み）</label>
          <select id="endSel"></select>
        </div>
      </div>

      <label>用途メモ（任意）</label>
      <textarea id="note" rows="2" placeholder="例：顧客訪問、備品搬入など"></textarea>

      <div class="actions">
        <button id="cancelModalBtn">キャンセル</button>
        <button id="saveModalBtn">予約する</button>
      </div>
    </div>
  </div>

  <!-- 予約変更モーダル（一覧から変更用） -->
  <div id="editOverlay" class="overlay">
    <div class="modal">
      <h3>予約の時間変更</h3>
      <div id="editInfo" class="small"></div>

      <div class="row">
        <div>
          <label>開始（15分刻み）</label>
          <select id="editStartSel"></select>
        </div>
        <div>
          <label>終了（15分刻み）</label>
          <select id="editEndSel"></select>
        </div>
      </div>

      <label>用途メモ（任意）</label>
      <textarea id="editNote" rows="2"></textarea>

      <div class="actions">
        <button id="cancelEditBtn">閉じる</button>
        <button id="saveEditBtn">変更する</button>
      </div>
    </div>
  </div>

  <!-- 初回ログイン：名前入力モーダル -->
  <div id="nameOverlay" class="overlay">
    <div class="modal">
      <h3>お名前の入力（初回のみ）</h3>
      <div class="small">苗字・名前を入力してください（予約・管理画面に反映されます）</div>

      <label>苗字</label>
      <input id="lastName" type="text" placeholder="例：山田" />

      <label>名前</label>
      <input id="firstName" type="text" placeholder="例：太郎" />

      <div class="actions">
        <button id="saveNameBtn">保存</button>
      </div>
    </div>
  </div>

  <!-- 共通ダイアログ -->
  <div id="dlgOverlay" class="overlay">
    <div class="modal">
      <h3 id="dlgTitle">お知らせ</h3>
      <div id="dlgMsg" style="margin-top:8px; white-space:pre-wrap;"></div>
      <div class="actions" style="margin-top:12px;">
        <button id="dlgOkBtn">OK</button>
      </div>
    </div>
  </div>

<script>
  // ✅ あなたの値
  const LIFF_ID = "2008829976-rJa7ANlR";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id)=>document.getElementById(id);

  let calendar = null;
  let carsChannel = null;

  let me = { userId: null, displayName: null };
  let userProfile = { fullName: null };

  let modalYmd = null;

  // 一覧の時間変更用
  let editing = { id:null, carId:null, ymd:null };

  // 車データ（全車）
  let carsAll = []; // [{id,name,is_active}]
  let carsMap = {}; // id -> name

  const pad = (n)=>String(n).padStart(2,"0");
  const TIMES = [...Array(96)].map((_,i)=>`${pad(Math.floor(i/4))}:${pad((i%4)*15)}`);

  function setStatus(text){ $("status").textContent = text; }

  function toYmd(d){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function fmtHm(d){
    return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function todayStartLocal(){
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  }

  function toISOFromYmdTime(ymd, hhmm){
    const [y, m, d] = ymd.split("-").map(Number);
    if (hhmm === "24:00") {
      const dt = new Date(y, m-1, d+1, 0, 0, 0, 0);
      return dt.toISOString();
    }
    const [hh, mm] = hhmm.split(":").map(Number);
    const dt = new Date(y, m-1, d, hh, mm, 0, 0);
    return dt.toISOString();
  }

  function floorTo15FromDateStr(dateStr){
    const m = dateStr.match(/^(\d{4}-\d{2}-\d{2})T(\d{2}):(\d{2})/);
    if(!m) return null;
    const ymd = m[1];
    const hh = m[2];
    const mm = parseInt(m[3], 10);
    const floored = Math.floor(mm / 15) * 15;
    const mm2 = String(floored).padStart(2, "0");
    return { ymd, hhmm: `${hh}:${mm2}` };
  }

  function showDialog(title, message){
    $("dlgTitle").textContent = title;
    $("dlgMsg").textContent = message;
    $("dlgOverlay").style.display = "flex";

    return new Promise(resolve => {
      const btn = $("dlgOkBtn");
      const handler = () => {
        btn.removeEventListener("click", handler);
        $("dlgOverlay").style.display = "none";
        resolve(true);
      };
      btn.addEventListener("click", handler);
    });
  }

  function showConfirm(title, message, okText="はい", cancelText="いいえ"){
    $("dlgTitle").textContent = title;
    $("dlgMsg").textContent = message;

    const actions = $("dlgOverlay").querySelector(".actions");
    actions.innerHTML = `
      <button id="dlgCancelBtn">${cancelText}</button>
      <button id="dlgOkBtn2">${okText}</button>
    `;

    $("dlgOverlay").style.display = "flex";

    return new Promise(resolve=>{
      const okBtn = document.getElementById("dlgOkBtn2");
      const cancelBtn = document.getElementById("dlgCancelBtn");

      const cleanup = ()=>{
        $("dlgOverlay").style.display = "none";
        actions.innerHTML = `<button id="dlgOkBtn">OK</button>`;
      };

      okBtn.addEventListener("click", ()=>{ cleanup(); resolve(true); });
      cancelBtn.addEventListener("click", ()=>{ cleanup(); resolve(false); });
    });
  }

  // ===== LIFF =====
  async function initLiff(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      setStatus("未ログイン：ログインします…");
      liff.login();
      return false;
    }
    const profile = await liff.getProfile();
    me.userId = profile.userId;
    me.displayName = profile.displayName;
    setStatus(`ログイン中：${me.displayName}`);
    return true;
  }

  // ===== cars =====
  async function fetchCarsAll(){
    const { data, error } = await sb.from("cars").select("id, name, is_active").order("id");
    if(error) throw error;

    carsAll = data || [];
    carsMap = {};
    carsAll.forEach(c => { carsMap[c.id] = c.name; });
  }

  function getSelectedCar(){
    const carId = Number($("car").value);
    return (carsAll || []).find(c => Number(c.id) === carId) || null;
  }

  function updateDimUi(){
    const car = getSelectedCar();
    const isActive = !(car && car.is_active === false);

    // バナー
    $("dimBanner").style.display = isActive ? "none" : "block";

    // カレンダーを薄くしてクリック無効（点検中のとき）
    const calEl = $("calendar");
    if(isActive){
      calEl.classList.remove("calendar-dim");
    }else{
      calEl.classList.add("calendar-dim");
    }

    // 予約モーダルの「予約する」を無効
    const saveBtn = $("saveModalBtn");
    if(saveBtn) saveBtn.disabled = !isActive;

    // ステータスに一言
    if(!isActive){
      setStatus(`ログイン中：${me.displayName}（点検中の車を選択）`);
    }else{
      setStatus(`ログイン中：${me.displayName}`);
    }
  }

  async function loadCarsDropdown(){
    const sel = $("car");
    const current = sel.value;

    if((carsAll || []).length === 0){
      sel.innerHTML = `<option value="">車が登録されていません</option>`;
      return;
    }

    // ✅ 点検中も表示（ラベル付）
    sel.innerHTML = (carsAll || []).map(c=>{
      const stop = (c.is_active === false) ? "（点検中）" : "";
      return `<option value="${c.id}">${c.name}${stop}</option>`;
    }).join("");

    if(current && (carsAll || []).some(c=>String(c.id)===String(current))){
      sel.value = current;
    }

    updateDimUi();
  }

  function subscribeCarsRealtime(){
    if(carsChannel){
      try { sb.removeChannel(carsChannel); } catch(_) {}
      carsChannel = null;
    }

    carsChannel = sb.channel("cars-changes")
      .on("postgres_changes", { event: "*", schema: "public", table: "cars" }, async () => {
        await safeReloadAll("車情報が更新されました");
      })
      .subscribe();
  }

  // ===== users（苗字・名前）=====
  async function loadOrAskUserName(){
    const { data, error } = await sb
      .from("users")
      .select("last_name, first_name")
      .eq("user_id", me.userId)
      .maybeSingle();

    if (error) {
      console.error(error);
      await showDialog("設定エラー", "usersテーブルの読み取りに失敗しました。\nRLSがONの場合は users の SELECT ポリシーが必要です。");
      throw error;
    }

    if (data && data.last_name && data.first_name) {
      userProfile.fullName = `${data.last_name} ${data.first_name}`;
      $("displayName").textContent = userProfile.fullName;
      return;
    }

    $("displayName").textContent = "未設定";
    $("lastName").value = "";
    $("firstName").value = "";
    $("nameOverlay").style.display = "flex";
  }

  // ===== 予約モーダル =====
  function openReservationModalByPicked(ymd, startHHMM){
    modalYmd = ymd;

    $("startSel").innerHTML = TIMES.map(t=>`<option value="${t}">${t}</option>`).join("");
    $("endSel").innerHTML = [...TIMES,"24:00"].map(t=>`<option value="${t}">${t}</option>`).join("");

    $("startSel").value = startHHMM;

    const [h, m] = startHHMM.split(":").map(Number);
    const startMin = h*60 + m;
    const endMin = Math.min(startMin + 30, 24*60);
    const endDefault = (endMin >= 24*60) ? "24:00" : `${pad(Math.floor(endMin/60))}:${pad(endMin%60)}`;
    $("endSel").value = endDefault;

    $("note").value = "";
    $("modalDate").textContent = `${modalYmd}`;
    $("overlay").style.display = "flex";
  }

  function openReservationModalAllDay(dateObj){
    modalYmd = toYmd(dateObj);

    $("startSel").innerHTML = TIMES.map(t=>`<option value="${t}">${t}</option>`).join("");
    $("endSel").innerHTML = [...TIMES,"24:00"].map(t=>`<option value="${t}">${t}</option>`).join("");

    $("startSel").value = "00:00";
    $("endSel").value = "24:00";

    $("note").value = "";
    $("modalDate").textContent = `${modalYmd}（終日）`;
    $("overlay").style.display = "flex";
  }

  // ===== 重複チェック =====
  async function hasOverlap(carId, startISO, endISO, excludeId=null){
    let q = sb
      .from("reservations")
      .select("id")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .limit(1);

    if(excludeId) q = q.neq("id", excludeId);

    const { data, error } = await q;
    if(error) throw error;
    return (data || []).length > 0;
  }

  // ===== 予約作成 =====
  async function createReservation(carId, startISO, endISO, note){
    // ✅ 点検中なら保存不可
    const car = getSelectedCar();
    if(car && car.is_active === false){
      await showDialog("予約できません", "この車は現在「点検中」で使用停止になっています。");
      return false;
    }

    const overlap = await hasOverlap(carId, startISO, endISO, null);
    if(overlap){
      await showDialog("予約できません", "その時間帯はすでに予約があります。\n別の車両か時間を変更してください。");
      return false;
    }

    const { error } = await sb.from("reservations").insert({
      car_id: carId,
      user_id: me.userId,
      user_name: userProfile.fullName ?? me.displayName,
      start_time: startISO,
      end_time: endISO,
      note: (note || "").trim()
    });

    if(error) throw error;
    return true;
  }

  // ===== キャンセル =====
  async function cancelReservation(reservationId, carName, dateText, startText, endText){
    const msg =
      `車：${carName}\n` +
      `日付：${dateText}\n` +
      `時間：${startText}〜${endText}\n` +
      `この予約を取り消します。よろしいですか？`;

    const yes = await showConfirm("予約をキャンセルしますか？", msg, "キャンセルする", "やめる");
    if(!yes) return false;

    const { error } = await sb
      .from("reservations")
      .delete()
      .eq("id", reservationId)
      .eq("user_id", me.userId);

    if(error){
      await showDialog("キャンセルできません", "キャンセルできませんでした（自分の予約のみキャンセル可）");
      return false;
    }

    await showDialog("キャンセルしました", "予約を取り消しました。");
    return true;
  }

  // ===== カレンダーイベント読み込み =====
  async function loadEvents(){
    if(!calendar) return;

    const carIdStr = $("car").value;
    if(!carIdStr) return;

    const carId = Number(carIdStr);
    const view = calendar.view;

    const startISO = view.activeStart.toISOString();
    const endISO = view.activeEnd.toISOString();

    const { data, error } = await sb
      .from("reservations")
      .select("id, user_id, user_name, start_time, end_time, note")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .order("start_time", { ascending: true });

    if(error){
      console.error(error);
      await showDialog("取得エラー", "reservations の取得に失敗しました。\nRLSがONの場合は reservations の SELECT ポリシーが必要です。");
      throw error;
    }

    calendar.removeAllEvents();

    (data || []).forEach(r=>{
      const isMine = (r.user_id === me.userId);
      const title = isMine ? `（自分）${r.note ? r.note : ""}`.trim() : "";

      calendar.addEvent({
        id: r.id,
        title,
        start: new Date(r.start_time),
        end: new Date(r.end_time),
        classNames: isMine ? ["mine-event"] : ["busy-other"],
        extendedProps: {
          uid: r.user_id,
          user_name: r.user_name
        }
      });
    });
  }

  function initCalendar(){
    calendar = new FullCalendar.Calendar($("calendar"),{
      locale:"ja",
      timeZone:"local",
      firstDay: 1,
      initialView:"timeGridWeek",

      buttonText:{today:"今日", timeGridDay:"日", timeGridWeek:"週"},
      headerToolbar:{left:"prev,next today", center:"title", right:"timeGridDay,timeGridWeek"},

      dayHeaderContent:(arg)=>{
        const d = arg.date;
        const m = d.getMonth()+1;
        const day = d.getDate();
        const wd = ["日","月","火","水","木","金","土"][d.getDay()];
        return { html: `${m}/${day}<br>(${wd})` };
      },

      allDaySlot:true,
      allDayText:"終日",

      slotDuration:"00:15:00",
      snapDuration:"00:15:00",

      slotMinTime:"00:00:00",
      slotMaxTime:"24:00:00",

      slotLabelFormat:{hour:"2-digit", minute:"2-digit", hour12:false},
      eventTimeFormat:{hour:"2-digit", minute:"2-digit", hour12:false},

      selectable:false,

      datesSet: async ()=>{
        await loadEvents();
      },

      dateClick:(info)=>{
        // ✅ 点検中ならモーダルを開かない（ただし閲覧はできる）
        const car = getSelectedCar();
        if(car && car.is_active === false){
          showDialog("予約できません", "この車は現在「点検中」で使用停止になっています。");
          return;
        }

        if(info.allDay){
          openReservationModalAllDay(info.date);
          return;
        }

        const picked = floorTo15FromDateStr(info.dateStr);
        if(!picked){
          const d = new Date(info.date);
          openReservationModalByPicked(toYmd(d), `${pad(d.getHours())}:${pad(d.getMinutes())}`);
          return;
        }
        openReservationModalByPicked(picked.ymd, picked.hhmm);
      },

      eventClick: async (info)=>{
        const isMine = info.event.extendedProps.uid === me.userId;

        const startD = info.event.start ? new Date(info.event.start) : null;
        const endD   = info.event.end ? new Date(info.event.end) : null;

        const start = startD ? fmtHm(startD) : "";
        const end   = endD ? fmtHm(endD) : "";
        const dateText = startD ? toYmd(startD) : "";

        if(isMine){
          const carName = $("car").options[$("car").selectedIndex]?.textContent || "";
          const ok = await cancelReservation(info.event.id, carName, dateText, start, end);
          if(ok){
            await safeReloadAll();
          }
          return;
        }

        const who = info.event.extendedProps.user_name || "不明";
        await showDialog("予約済み", `利用者：${who}\n日付：${dateText}\n時間：${start}〜${end}`);
      },
    });

    calendar.render();
  }

  // ===== 自分の予約一覧（全車／今日以降すべて）=====
  function groupByDate(rows){
    const map = {};
    rows.forEach(r=>{ (map[r.ymd] ||= []).push(r); });
    return map;
  }

  async function loadMyReservationsAll(){
    const startISO = todayStartLocal().toISOString();

    const { data, error } = await sb
      .from("reservations")
      .select("id, car_id, user_id, start_time, end_time, note")
      .eq("user_id", me.userId)
      .gte("start_time", startISO)
      .order("start_time", { ascending: true });

    if(error){
      console.error(error);
      $("myList").innerHTML = `<div class="small">予約一覧の取得に失敗しました（reservations SELECT 権限/RLSを確認）</div>`;
      return;
    }

    const rows = (data || []).map(r=>{
      const s = new Date(r.start_time);
      const e = new Date(r.end_time);
      return {
        id: r.id,
        car_id: r.car_id,
        ymd: toYmd(s),
        startHHMM: fmtHm(s),
        endHHMM: fmtHm(e),
        note: r.note || ""
      };
    });

    if(rows.length === 0){
      $("myList").innerHTML = `<div class="small">今日以降の予約はありません</div>`;
      return;
    }

    const grouped = groupByDate(rows);
    const dates = Object.keys(grouped).sort();

    let html = "";
    dates.forEach(d=>{
      html += `<div class="dateHeader">${d}</div>`;
      grouped[d].forEach(r=>{
        const carName = carsMap?.[Number(r.car_id)] ?? `車ID:${r.car_id}`;
        const main = `${carName}　${r.startHHMM}〜${r.endHHMM}`;
        const sub = r.note ? `メモ：${r.note}` : "";

        html += `
          <div class="myCard">
            <div class="myLeft">
              <div class="myMain">${main}</div>
              ${sub ? `<div class="mySub">${sub}</div>` : `<div class="mySub"></div>`}
            </div>
            <div class="myActions">
              <button class="btnDanger" data-cancel="${r.id}">キャンセル</button>
            </div>
          </div>
        `;
      });
    });

    $("myList").innerHTML = html;

    document.querySelectorAll("[data-cancel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-cancel");
        const r = rows.find(x=>String(x.id)===String(id));
        if(!r) return;

        const carName = carsMap?.[Number(r.car_id)] ?? `車ID:${r.car_id}`;
        const ok = await cancelReservation(r.id, carName, r.ymd, r.startHHMM, r.endHHMM);
        if(ok){
          await safeReloadAll();
        }
      });
    });
  }

  // ===== 安全に全再読込（止まり対策）=====
  async function safeReloadAll(msg){
    try{
      if(msg) setStatus(msg);

      await fetchCarsAll();
      await loadCarsDropdown();
      updateDimUi();

      if(calendar) await loadEvents();
      await loadMyReservationsAll();

      setStatus(`ログイン中：${me.displayName}`);
    }catch(e){
      console.error(e);
      setStatus("読み込みエラー：RLS（SELECT権限）を確認してください");
      await showDialog("読み込みエラー", "データの取得に失敗しました。\nSupabaseで cars / users / reservations の SELECT ポリシー（RLS）を確認してください。");
    }
  }

  // ===== UIイベント =====
  $("reloadBtn").addEventListener("click", ()=>safeReloadAll("再読み込み中…"));

  $("car").addEventListener("change", async ()=>{
    updateDimUi();
    try{
      await loadEvents();
    }catch(_){}
  });

  $("cancelModalBtn").addEventListener("click", ()=>{ $("overlay").style.display="none"; });
  $("cancelEditBtn").addEventListener("click", ()=>{ $("editOverlay").style.display="none"; });

  $("saveModalBtn").addEventListener("click", async ()=>{
    try{
      if(!userProfile.fullName){
        await showDialog("名前未登録", "先に「苗字・名前」の登録をしてください。");
        $("nameOverlay").style.display = "flex";
        return;
      }

      const carIdStr = $("car").value;
      if(!carIdStr){
        await showDialog("車を選択", "車が選択されていません。");
        return;
      }

      const car = getSelectedCar();
      if(car && car.is_active === false){
        await showDialog("予約できません", "この車は現在「点検中」で使用停止になっています。");
        return;
      }

      const carId = Number(carIdStr);
      const startStr = $("startSel").value;
      const endStr = $("endSel").value;

      const startISO = toISOFromYmdTime(modalYmd, startStr);
      const endISO = toISOFromYmdTime(modalYmd, endStr);

      if(new Date(startISO) >= new Date(endISO)){
        await showDialog("入力エラー", "終了は開始より後にしてください。");
        return;
      }

      const ok = await createReservation(carId, startISO, endISO, $("note").value);
      if(ok){
        $("overlay").style.display="none";
        await safeReloadAll();
      }
    }catch(e){
      console.error(e);
      await showDialog("予約に失敗", "予約に失敗しました（RLS/設定値/DBを確認）");
    }
  });

  $("saveNameBtn").addEventListener("click", async ()=>{
    const last = $("lastName").value.trim();
    const first = $("firstName").value.trim();

    if(!last || !first){
      await showDialog("入力エラー", "苗字と名前を入力してください。");
      return;
    }

    const { error } = await sb.from("users").upsert({
      user_id: me.userId,
      last_name: last,
      first_name: first
    });

    if(error){
      console.error(error);
      await showDialog("保存に失敗", "保存に失敗しました（users RLS/権限を確認）");
      return;
    }

    userProfile.fullName = `${last} ${first}`;
    $("displayName").textContent = userProfile.fullName;
    $("nameOverlay").style.display = "none";
  });

  // ===== 起動 =====
  (async ()=>{
    try{
      const ok = await initLiff();
      if(!ok) return;

      await fetchCarsAll();
      await loadCarsDropdown();
      subscribeCarsRealtime();

      await loadOrAskUserName();

      initCalendar();

      await safeReloadAll();

    }catch(e){
      console.error(e);
      setStatus("初期化エラー：設定（LIFF/Supabase/RLS）を確認してください");
      await showDialog("初期化エラー", "初期化に失敗しました。\nSupabaseのRLS（SELECT権限）を確認してください。");
    }
  })();

  function showSupabaseError(where, error){
  const msg = `[${where}] ${error?.message || error}`;
  console.error(msg, error);
  $("status").textContent = msg;
  alert(msg);
}

</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>社用車予約</title>

  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", sans-serif; margin:12px; line-height:1.5;}
    .topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
    .badge{font-size:13px; color:#444;}
    select, button{padding:10px; font-size:16px;}
    #status{font-size:13px; color:#666;}
    .hint{font-size:12px; color:#666; margin:6px 0 10px;}
    /* カレンダーがスマホで詰まるのを少し緩和 */
    .fc .fc-toolbar-title{font-size:18px;}
  </style>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- FullCalendar（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
</head>
<body>
  <div class="topbar">
    <b>社用車予約</b>
    <span id="status">初期化中…</span>

    <span class="badge">車：</span>
    <select id="car"></select>

    <button id="reloadBtn">再読み込み</button>
  </div>

  <div class="hint">
    ・ドラッグで時間範囲を選択すると予約できます（15分単位）<br>
    ・自分の予約はクリックでキャンセルできます（他人の予約は不可）
  </div>

  <div id="calendar"></div>

<script>
  // ★ここをあなたの値に差し替え
  const LIFF_ID = "2008829976-rJa7ANlR";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);

  let me = { userId: null, displayName: null };
  let calendar = null;

  function setStatus(text){ $("status").textContent = text; }

  async function initLiff(){
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      setStatus("未ログイン：ログインします…");
      liff.login();
      return false;
    }

    const profile = await liff.getProfile();
    me.userId = profile.userId;
    me.displayName = profile.displayName;
    setStatus(`ログイン中：${me.displayName}`);
    return true;
  }

  async function loadCars(){
    const { data, error } = await sb.from("cars").select("*").order("id");
    if(error) throw error;

    $("car").innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
  }

  function getSelectedCarId(){
    return Number($("car").value);
  }

  async function fetchReservations(carId, startISO, endISO){
    // 画面表示範囲の予約だけ取る
    const { data, error } = await sb
      .from("reservations")
      .select("id, car_id, user_id, user_name, start_time, end_time, note")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .order("start_time", { ascending: true });

    if(error) throw error;
    return data;
  }

  async function hasOverlap(carId, startISO, endISO){
    const { data, error } = await sb
      .from("reservations")
      .select("id")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .limit(1);
    if(error) throw error;
    return data.length > 0;
  }

  async function createReservation(carId, startISO, endISO){
    const note = prompt("用途メモ（任意）を入力してください：", "") ?? "";
    const overlap = await hasOverlap(carId, startISO, endISO);
    if(overlap){
      alert("その時間帯は既に予約があります。別の車両か時間を変更してください。");
      return false;
    }

    const { error } = await sb.from("reservations").insert({


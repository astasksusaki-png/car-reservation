<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>社用車予約</title>

  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", sans-serif; margin:12px; line-height:1.5;}
    .topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
    .badge{font-size:13px; color:#444;}
    select, button{padding:10px; font-size:16px;}
    #status{font-size:13px; color:#666;}
    .hint{font-size:12px; color:#666; margin:6px 0 10px;}
    /* カレンダーがスマホで詰まるのを少し緩和 */
    .fc .fc-toolbar-title{font-size:18px;}
  </style>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- FullCalendar（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
</head>
<body>
  <div class="topbar">
    <b>社用車予約</b>
    <span id="status">初期化中…</span>

    <span class="badge">車：</span>
    <select id="car"></select>

    <button id="reloadBtn">再読み込み</button>
  </div>

  <div class="hint">
    ・ドラッグで時間範囲を選択すると予約できます（15分単位）<br>
    ・自分の予約はクリックでキャンセルできます（他人の予約は不可）
  </div>

  <div id="calendar"></div>

<script>
  // ★ここをあなたの値に差し替え
  const LIFF_ID = "2008829976-rJa7ANlR";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);

  let me = { userId: null, displayName: null };
  let calendar = null;

  function setStatus(text){ $("status").textContent = text; }

  async function initLiff(){
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      setStatus("未ログイン：ログインします…");
      liff.login();
      return false;
    }

    const profile = await liff.getProfile();
    me.userId = profile.userId;
    me.displayName = profile.displayName;
    setStatus(`ログイン中：${me.displayName}`);
    return true;
  }

  async function loadCars(){
    const { data, error } = await sb.from("cars").select("*").order("id");
    if(error) throw error;

    $("car").innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
  }

  function getSelectedCarId(){
    return Number($("car").value);
  }

  async function fetchReservations(carId, startISO, endISO){
    // 画面表示範囲の予約だけ取る
    const { data, error } = await sb
      .from("reservations")
      .select("id, car_id, user_id, user_name, start_time, end_time, note")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .order("start_time", { ascending: true });

    if(error) throw error;
    return data;
  }

  async function hasOverlap(carId, startISO, endISO){
    const { data, error } = await sb
      .from("reservations")
      .select("id")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .limit(1);
    if(error) throw error;
    return data.length > 0;
  }

  async function createReservation(carId, startISO, endISO){
    const note = prompt("用途メモ（任意）を入力してください：", "") ?? "";
    const overlap = await hasOverlap(carId, startISO, endISO);
    if(overlap){
      alert("その時間帯は既に予約があります。別の車両か時間を変更してください。");
      return false;
    }

    const { error } = await sb.from("reservations").insert({
      car_id: carId,
      user_id: me.userId,
      user_name: me.displayName,
      start_time: startISO,
      end_time: endISO,
      note: note.trim()
    });
    if(error) throw error;
    return true;
  }

  async function cancelReservation(reservationId){
    if(!confirm("この予約をキャンセルしますか？")) return false;

    // 自分の予約だけ削除できるようにしておく（簡易ガード）
    const { error } = await sb
      .from("reservations")
      .delete()
      .eq("id", reservationId)
      .eq("user_id", me.userId);

    if(error){
      alert("キャンセルできませんでした（自分の予約のみキャンセル可）");
      return false;
    }
    return true;
  }

  function buildEvents(reservations){
    // FullCalendarのeventに変換
    return reservations.map(r => {
      const isMine = (r.user_id === me.userId);
      const title = isMine
        ? `（自分）${r.note ? r.note : ""}`.trim()
        : `${r.user_name}${r.note ? " / " + r.note : ""}`;

      return {
        id: r.id,
        title,
        start: r.start_time,
        end: r.end_time,
        extendedProps: {
          user_id: r.user_id,
          user_name: r.user_name,
          note: r.note
        }
        // 色は指定しない（デフォルトのまま）
      };
    });
  }

  async function refetchCalendarEvents(){
    if(!calendar) return;

    const carId = getSelectedCarId();
    const view = calendar.view;

    const startISO = view.activeStart.toISOString();
    const endISO = view.activeEnd.toISOString();

    const reservations = await fetchReservations(carId, startISO, endISO);
    const events = buildEvents(reservations);

    calendar.removeAllEvents();
    calendar.addEventSource(events);
  }

  function initCalendar(){
    const el = document.getElementById("calendar");

    calendar = new FullCalendar.Calendar(el, {
      initialView: "timeGridWeek",
      timeZone: "Asia/Tokyo",

      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "timeGridDay,timeGridWeek"
      },

      // 15分単位
      slotDuration: "00:15:00",
      snapDuration: "00:15:00",

      selectable: true,
      selectMirror: true,

      // 見た目の時間幅（必要なら調整）
      slotMinTime: "06:00:00",
      slotMaxTime: "22:00:00",

      // 表示範囲が変わったら予約を取り直す
      datesSet: async () => {
        try { await refetchCalendarEvents(); }
        catch(e){ console.error(e); alert("予約データの取得に失敗しました"); }
      },

      // 予約作成（ドラッグ選択）
      select: async (info) => {
        try{
          const carId = getSelectedCarId();
          // FullCalendarはDateをくれるのでISOで保存
          const startISO = info.start.toISOString();
          const endISO = info.end.toISOString();

          if(info.start >= info.end){
            calendar.unselect();
            return;
          }

          const ok = await createReservation(carId, startISO, endISO);
          calendar.unselect();
          if(ok) await refetchCalendarEvents();
        }catch(e){
          console.error(e);
          alert("予約に失敗しました（設定値やDBを確認）");
          calendar.unselect();
        }
      },

      // 予約クリック（自分の予約だけキャンセル許可）
      eventClick: async (info) => {
        const isMine = info.event.extendedProps.user_id === me.userId;
        if(!isMine){
          alert("他人の予約はキャンセルできません。");
          return;
        }
        const ok = await cancelReservation(info.event.id);
        if(ok) await refetchCalendarEvents();
      }
    });

    calendar.render();
  }

  (async () => {
    try{
      const ok = await initLiff();
      if(!ok) return;

      await loadCars();

      $("car").addEventListener("change", async ()=> {
        try{ await refetchCalendarEvents(); } catch(e){ console.error(e); }
      });

      $("reloadBtn").addEventListener("click", async ()=> {
        try{ await refetchCalendarEvents(); } catch(e){ console.error(e); }
      });

      initCalendar();
    }catch(e){
      console.error(e);
      setStatus("初期化エラー：設定（LIFF/Supabase）を確認してください");
      alert("初期化に失敗しました。コンソールを確認してください。");
    }
  })();
</script>
</body>
</html>

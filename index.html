<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>社用車予約</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", sans-serif; margin:16px; line-height:1.5;}
    .card{border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0;}
    label{display:block; margin-top:10px; font-weight:600;}
    input, select, textarea, button{width:100%; padding:10px; font-size:16px; margin-top:6px;}
    button{cursor:pointer;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .small{color:#666; font-size:13px;}
    .ok{color:green;}
    .ng{color:#c00;}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>社用車予約</h1>
  <p class="small">LINEでログインして予約できます。</p>

  <div class="card">
    <div id="status" class="small">初期化中…</div>

    <label>車</label>
    <select id="car"></select>

    <div class="row">
      <div>
        <label>開始</label>
        <input id="start" type="datetime-local" />
      </div>
      <div>
        <label>終了</label>
        <input id="end" type="datetime-local" />
      </div>
    </div>

    <label>用途メモ（任意）</label>
    <textarea id="note" rows="2" placeholder="例：顧客訪問、備品搬入など"></textarea>

    <button id="bookBtn">予約する</button>
    <p id="msg" class="small"></p>
  </div>

  <div class="card">
    <h2>自分の予約</h2>
    <button id="reloadMine">更新</button>
    <div id="mine" class="small"></div>
  </div>

<script>
  // ★ここをあなたの値に差し替え
  const LIFF_ID = "2008829974-k2ClDIBL";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let me = { userId: null, displayName: null };

  const $ = (id) => document.getElementById(id);

  function setMsg(text, ok=true){
    $("msg").textContent = text;
    $("msg").className = "small " + (ok ? "ok" : "ng");
  }

  function toISO(dtLocal){
    // datetime-local → ISO文字列
    // 例: "2026-01-06T10:00" → new Date(...) でOK（ローカル扱い）
    const d = new Date(dtLocal);
    return d.toISOString();
  }

  async function loadCars(){
    const { data, error } = await sb.from("cars").select("*").order("id");
    if(error) throw error;
    $("car").innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
  }

  async function initLiff(){
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      $("status").innerHTML = `<span class="ng">未ログイン</span>：ログイン画面へ移動します…`;
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    me.userId = profile.userId;
    me.displayName = profile.displayName;

    $("status").innerHTML = `<span class="ok">ログイン中</span>：${me.displayName}`;
  }

  async function hasOverlap(carId, startISO, endISO){
    // 重複判定：同じ車で時間がかぶっている予約があるか
    // 条件：既存.start < 新.end AND 既存.end > 新.start
    const { data, error } = await sb
      .from("reservations")
      .select("id")
      .eq("car_id", carId)
      .lt("start_time", endISO)
      .gt("end_time", startISO)
      .limit(1);

    if(error) throw error;
    return data.length > 0;
  }

  async function book(){
    try{
      setMsg("");

      const carId = Number($("car").value);
      const startVal = $("start").value;
      const endVal = $("end").value;
      const note = $("note").value.trim();

      if(!startVal || !endVal) return setMsg("開始と終了を入力してください。", false);

      const startISO = toISO(startVal);
      const endISO = toISO(endVal);

      if (new Date(startISO) >= new Date(endISO)) {
        return setMsg("終了は開始より後にしてください。", false);
      }

      const overlap = await hasOverlap(carId, startISO, endISO);
      if(overlap) return setMsg("その時間帯は既に予約があります。別の時間にしてください。", false);

      const { error } = await sb.from("reservations").insert({
        car_id: carId,
        user_id: me.userId,
        user_name: me.displayName,
        start_time: startISO,
        end_time: endISO,
        note
      });
      if(error) throw error;

      setMsg("予約しました。");
      $("note").value = "";
      await loadMine();
    }catch(e){
      console.error(e);
      setMsg("エラー：設定値（LIFF_ID / SUPABASE）やテーブル名を確認してください。", false);
    }
  }

  async function cancel(id){
    if(!confirm("この予約をキャンセルしますか？")) return;
    const { error } = await sb.from("reservations").delete().eq("id", id).eq("user_id", me.userId);
    if(error) return setMsg("キャンセル失敗（権限/ID）", false);
    setMsg("キャンセルしました。");
    await loadMine();
  }

  async function loadMine(){
    const { data, error } = await sb
      .from("reservations")
      .select("id, car_id, start_time, end_time, note, cars(name)")
      .eq("user_id", me.userId)
      .order("start_time", { ascending: true })
      .limit(50);

    if(error){
      console.error(error);
      $("mine").textContent = "読み込み失敗";
      return;
    }

    if(data.length === 0){
      $("mine").textContent = "予約はありません。";
      return;
    }

    $("mine").innerHTML = data.map(r => {
      const s = new Date(r.start_time).toLocaleString();
      const e = new Date(r.end_time).toLocaleString();
      const carName = r.cars?.name ?? ("車ID:" + r.car_id);
      const note = r.note ? ` / ${r.note}` : "";
      return `
        <div class="card">
          <div><b>${carName}</b></div>
          <div class="small">${s} 〜 ${e}${note}</div>
          <button onclick="cancel('${r.id}')">キャンセル</button>
        </div>
      `;
    }).join("");
  }

  // グローバルに公開（onclickから呼ぶため）
  window.cancel = cancel;

  (async () => {
    try{
      await initLiff();
      await loadCars();
      $("bookBtn").addEventListener("click", book);
      $("reloadMine").addEventListener("click", loadMine);
      await loadMine();
    }catch(e){
      console.error(e);
      $("status").innerHTML = `<span class="ng">初期化エラー</span>`;
      setMsg("LIFF_ID / SUPABASE設定を確認してください。", false);
    }
  })();
</script>
</body>
</html>

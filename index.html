<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>社用車予約</title>

  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", sans-serif; margin:12px; line-height:1.5;}
    .topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
    .badge{font-size:13px; color:#444;}
    select, button{padding:10px; font-size:16px;}
    #status{font-size:13px; color:#666;}
    .hint{font-size:12px; color:#666; margin:6px 0 10px;}
    .fc .fc-toolbar-title{font-size:18px;}

    /* 日付ヘッダが重ならないように */
    .fc .fc-col-header-cell-cushion{
      white-space: normal;
      font-size: 12px;
      line-height: 1.2;
      padding: 4px 2px;
    }

    /* ===== モーダル ===== */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .modal{
      width:100%;
      max-width:420px;   /* ← 横幅を抑える */
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .modal h3{margin:0 0 8px 0; font-size:18px;}
    .modal .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .modal label{display:block; font-size:13px; color:#444; margin-top:10px;}
    .modal textarea{
      width:100%;        /* ← はみ出し防止 */
      max-width:100%;
      box-sizing:border-box;
      padding:10px;
      font-size:16px;
      margin-top:6px;
      resize:vertical;
    }
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px;}
    .small{font-size:12px; color:#666;}
  </style>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
</head>

<body>
  <div class="topbar">
    <b>社用車予約</b>
    <span id="status">初期化中…</span>
    <span class="badge">車：</span>
    <select id="car"></select>
    <button id="reloadBtn">再読み込み</button>
  </div>

  <div class="hint">
    ・時間枠をタップして開始→終了を15分刻みで選択<br>
    ・終日をタップすると 00:00〜24:00 を選択できます
  </div>

  <div id="calendar"></div>

  <!-- モーダル -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h3>予約作成</h3>
      <div id="modalDate" class="small"></div>

      <div class="row">
        <div>
          <label>開始</label>
          <select id="startSel"></select>
        </div>
        <div>
          <label>終了</label>
          <select id="endSel"></select>
        </div>
      </div>

      <label>用途メモ（任意）</label>
      <textarea id="note" rows="2"></textarea>

      <div class="actions">
        <button id="cancelModalBtn">キャンセル</button>
        <button id="saveModalBtn">予約する</button>
      </div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008829976-rJa7ANlR";
  const SUPABASE_URL = "https://jmobmcphzqxbybkqpwfd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb2JtY3BoenF4Ynlia3Fwd2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjkyMTMsImV4cCI6MjA4MzI0NTIxM30.TTaR9DKpCtkWa3RFB9zE7IydwhD9bWGIbp83YbUX8v8";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id)=>document.getElementById(id);
  let me={}, calendar=null, modalYmd=null;

  const pad=n=>String(n).padStart(2,"0");
  const times=[...Array(96)].map((_,i)=>`${pad(Math.floor(i/4))}:${pad((i%4)*15)}`);

  function toYmd(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
  function iso(ymd,t){let[d,h]=[ymd,t==="24:00"?24:parseInt(t)],m=t==="24:00"?0:parseInt(t.split(":")[1]);let dt=new Date(...ymd.split("-").map(Number));dt.setHours(h,m,0,0);if(t==="24:00")dt.setDate(dt.getDate()+1);return dt.toISOString();}
  function round15(d){d=new Date(d);d.setSeconds(0,0);d.setMinutes(Math.round(d.getMinutes()/15)*15);return d;}

  async function init(){
    await liff.init({liffId:LIFF_ID});
    if(!liff.isLoggedIn()) return liff.login();
    me=await liff.getProfile();
    $("status").textContent=`ログイン中：${me.displayName}`;

    const {data}=await sb.from("cars").select("*").order("id");
    $("car").innerHTML=data.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");

    calendar=new FullCalendar.Calendar($("calendar"),{
      locale:"ja",
      timeZone:"Asia/Tokyo",
      firstDay:1,                 /* ← 月曜始まり */
      initialView:"timeGridWeek",
      buttonText:{today:"今日",timeGridDay:"日",timeGridWeek:"週"},
      headerToolbar:{left:"prev,next today",center:"title",right:"timeGridDay,timeGridWeek"},
      dayHeaderContent:a=>({html:`${a.date.getMonth()+1}/${a.date.getDate()}<br>(${["日","月","火","水","木","金","土"][a.date.getDay()]})`}),
      allDaySlot:true,
      allDayText:"終日",
      slotDuration:"00:15:00",
      slotMinTime:"00:00:00",
      slotMaxTime:"24:00:00",
      slotLabelFormat:{hour:"2-digit",minute:"2-digit",hour12:false},
      eventTimeFormat:{hour:"2-digit",minute:"2-digit",hour12:false},
      datesSet:loadEvents,
      dateClick:i=>openModal(i.allDay?i.date:round15(i.date)),
      eventClick:e=>e.event.extendedProps.uid===me.userId&&del(e.event.id)
    });
    calendar.render();
    loadEvents();
  }

  async function loadEvents(){
    const v=calendar.view, car=+$("car").value;
    const {data}=await sb.from("reservations").select("*")
      .eq("car_id",car).lt("start_time",v.activeEnd.toISOString())
      .gt("end_time",v.activeStart.toISOString());
    calendar.removeAllEvents();
    data.forEach(r=>calendar.addEvent({id:r.id,start:r.start_time,end:r.end_time,title:r.user_name,extendedProps:{uid:r.user_id}}));
  }

  function openModal(d){
    modalYmd=toYmd(d);
    $("startSel").innerHTML=times.map(t=>`<option>${t}</option>`).join("");
    $("endSel").innerHTML=[...times,"24:00"].map(t=>`<option>${t}</option>`).join("");
    $("overlay").style.display="flex";
    $("modalDate").textContent=modalYmd;
  }

  $("saveModalBtn").onclick=async()=>{
    const s=iso(modalYmd,$("startSel").value), e=iso(modalYmd,$("endSel").value);
    if(new Date(s)>=new Date(e)) return alert("終了は開始より後にしてください");
    await sb.from("reservations").insert({car_id:+$("car").value,user_id:me.userId,user_name:me.displayName,start_time:s,end_time:e,note:$("note").value});
    $("overlay").style.display="none";
    loadEvents();
  };
  $("cancelModalBtn").onclick=()=>{$("overlay").style.display="none";};

  init();
</script>
</body>
</html>
